/**
 * postal - Pub/Sub library providing wildcard subscriptions, complex message handling, etc.  Works server and client-side.
 * Author: Jim Cowart (http://freshbrewedcode.com/jimcowart)
 * Version: v0.11.1
 * Url: http://github.com/postaljs/postal.js
 * License(s): MIT
 */
(function(t,n){if("function"==typeof define&&define.amd)define(["lodash"],function(e){return n(e,t)});else if("object"==typeof module&&module.exports){var e={after:require("lodash.after"),any:require("lodash.some"),bind:require("lodash.bind"),clone:require("lodash.clone"),debounce:require("lodash.debounce"),each:require("lodash.forEach"),filter:require("lodash.filter"),isArray:require("lodash.isarray"),isEmpty:require("lodash.isempty"),isEqual:require("lodash.isequal"),isFunction:require("lodash.isfunction"),isNumber:require("lodash.isnumber"),isObject:require("lodash.isobject"),isString:require("lodash.isstring"),throttle:require("lodash.throttle")};module.exports=n(e,this)}else t.postal=n(t._,t)})(this,function(t,n,e){function i(t,n){return function(){if(console.warn||console.log){var e="Warning, the "+t+" method has been deprecated. Please use "+n+" instead.";console.warn?console.warn(e):console.log(e)}return f.prototype[n].apply(this,arguments)}}function r(){for(;E.length;)u.unsubscribe(E.shift())}function s(t,n,e){return function(i,r,s){i===t&&s.splice(r,1),0===s.length&&delete e[n]}}function c(t,n,e,i,r){return function(s){t.resolver.compare(s.topic,n)&&(e.push(s),s.cacheKeys.push(i),r&&r(s))}}function o(t,n){return{channel:u.configuration.SYSTEM_CHANNEL,topic:"subscription."+t,data:{event:"subscription."+t,channel:n.channel,topic:n.topic}}}function a(n,e){return"function"==typeof n?n:n?function(i){var r=0,s=0;return t.each(n,function(t,c){r+=1,("topic"===c&&e.compare(i.topic,n.topic)||"context"===c&&n.context===i._context||i[c]===n[c])&&(s+=1)}),r===s}:function(){return!0}}var u,h=n.postal,l=function(t,n){this.bus=n,this.channel=t||u.configuration.DEFAULT_CHANNEL};l.prototype.subscribe=function(){return this.bus.subscribe({channel:this.channel,topic:1===arguments.length?arguments[0].topic:arguments[0],callback:1===arguments.length?arguments[0].callback:arguments[1]})},l.prototype.publish=function(){var t=1===arguments.length?"[object String]"===Object.prototype.toString.call(arguments[0])?{topic:arguments[0]}:arguments[0]:{topic:arguments[0],data:arguments[1]};t.channel=this.channel,this.bus.publish(t)};var f=function(t,n,i){if(3!==arguments.length)throw new Error("You must provide a channel, topic and callback when creating a SubscriptionDefinition instance.");if(0===n.length)throw new Error("Topics cannot be empty");this.channel=t,this.topic=n,this.callback=i,this.pipeline=[],this.cacheKeys=[],this._context=e},p=function(){var n;return function(e){var i=!1;return t.isString(e)?(i=e===n,n=e):(i=t.isEqual(e,n),n=t.clone(e)),!i}},b=function(){var n=[];return function(e){var i=!t.any(n,function(n){return t.isObject(e)||t.isArray(e)?t.isEqual(e,n):e===n});return i&&n.push(e),i}};f.prototype={"catch":function(t){var n=this.callback,e=function(){try{n.apply(this,arguments)}catch(e){t(e,arguments[0])}};return this.callback=e,this},defer:function(){return this.delay(0)},disposeAfter:function(n){if(!t.isNumber(n)||0>=n)throw new Error("The value provided to disposeAfter (maxCalls) must be a number greater than zero.");var e=this,i=t.after(n,t.bind(function(){e.unsubscribe()}));return e.pipeline.push(function(t,n,e){e(t,n),i()}),e},distinct:function(){return this.constraint(new b)},distinctUntilChanged:function(){return this.constraint(new p)},invokeSubscriber:function(t,n){if(!this.inactive){var e=this,i=e.pipeline,r=i.length,s=e._context,c=-1;if(r){i=i.concat([e.callback]);var o=function a(t,n){c+=1,r>c?i[c].call(s,t,n,a):e.callback.call(s,t,n)};o(t,n,0)}else e.callback.call(s,t,n)}},logError:function(){if(console){var t;t=console.warn?console.warn:console.log,this["catch"](t)}return this},once:function(){return this.disposeAfter(1)},subscribe:function(t){return this.callback=t,this},unsubscribe:function(){this.inactive||u.unsubscribe(this)},constraint:function(n){if(!t.isFunction(n))throw new Error("Predicate constraint must be a function");return this.pipeline.push(function(t,e,i){n.call(this,t,e)&&i(t,e)}),this},constraints:function(n){var e=this;return t.isArray(n)&&t.each(n,function(t){e.constraint(t)}),e},context:function(t){return this._context=t,this},debounce:function(n,e){if(!t.isNumber(n))throw new Error("Milliseconds must be a number");return this.pipeline.push(t.debounce(function(t,n,e){e(t,n)},n,!!e)),this},delay:function(n){if(!t.isNumber(n))throw new Error("Milliseconds must be a number");var e=this;return e.pipeline.push(function(t,e,i){setTimeout(function(){i(t,e)},n)}),this},throttle:function(n){if(!t.isNumber(n))throw new Error("Milliseconds must be a number");var e=function(t,n,e){e(t,n)};return this.pipeline.push(t.throttle(e,n)),this}};for(var d=["withConstraint","withConstraints","withContext","withDebounce","withDelay","withThrottle"],g=["constraint","constraints","context","debounce","delay","throttle"],m=0;6>m;m++){var v=d[m];f.prototype[v]=i(v,g[m])}var y={cache:{},regex:{},compare:function(t,n){var e,i,r,s=this.cache[n+"-"+t];return s===!0?s:-1===t.indexOf("#")&&-1===t.indexOf("*")?s=this.cache[n+"-"+t]=n===t:((i=this.regex[t])||(e="^"+t.split(".").map(function(t){var n="";return r&&(n="#"!==r?"\\.\\b":"\\b"),n+="#"===t?"[\\s\\S]*":"*"===t?"[^.]+":t,r=t,n}).join("")+"$",i=this.regex[t]=new RegExp(e)),s=this.cache[n+"-"+t]=i.test(n))},reset:function(){this.cache={},this.regex={}}},w=0,E=[],_=o.bind(this,"created"),S=o.bind(this,"removed");if(u={cache:{},configuration:{resolver:y,DEFAULT_CHANNEL:"/",SYSTEM_CHANNEL:"postal",enableSystemMessages:!0,cacheKeyDelimiter:"|"},subscriptions:{},wireTaps:[],ChannelDefinition:l,SubscriptionDefinition:f,channel:function(t){return new l(t,this)},addWireTap:function(t){var n=this;return n.wireTaps.push(t),function(){var e=n.wireTaps.indexOf(t);-1!==e&&n.wireTaps.splice(e,1)}},noConflict:function(){if("undefined"==typeof window||"undefined"!=typeof window&&"function"==typeof define&&define.amd)throw new Error("noConflict can only be used in browser clients which aren't using AMD modules");return n.postal=h,this},getSubscribersFor:function(n){var e=[],i=this;return t.each(i.subscriptions,function(r){t.each(r,function(r){e=e.concat(t.filter(r,a(n,i.configuration.resolver)))})}),e},publish:function(n){++w;var e=this.configuration,i=n.channel=n.channel||e.DEFAULT_CHANNEL,s=n.topic;n.timeStamp=new Date,this.wireTaps.length&&t.each(this.wireTaps,function(t){t(n.data,n,w)});var o=i+e.cacheKeyDelimiter+s,a=this.cache[o];if(a)t.each(a,function(t){t.invokeSubscriber(n.data,n)});else{a=this.cache[o]=[];var u=c(e,s,a,o,function(t){t.invokeSubscriber(n.data,n)});t.each(this.subscriptions[i],function(n){t.each(n,u)})}0===--w&&r()},reset:function(){this.unsubscribeFor(),this.configuration.resolver.reset(),this.subscriptions={}},subscribe:function(n){var e,i=this.subscriptions,r=new f(n.channel||this.configuration.DEFAULT_CHANNEL,n.topic,n.callback),s=i[r.channel],o=r.channel.length,a=this.configuration;return s||(s=i[r.channel]={}),e=i[r.channel][r.topic],e||(e=i[r.channel][r.topic]=[]),e.push(r),t.each(this.cache,function(t,n){n.substr(0,o)===r.channel&&c(a,n.split(a.cacheKeyDelimiter)[1],t,n)(r)}),this.configuration.enableSystemMessages&&this.publish(_(r)),r},unsubscribe:function(){for(var n,e,i,r,c=arguments.length,o=0;c>o;o++){if(n=arguments[o],n.inactive=!0,w)return E.push(n),void 0;if(e=this.subscriptions[n.channel],i=e&&e[n.topic]){var a=i.length;for(r=0;a>r;){if(i[r]===n){i.splice(r,1);break}r+=1}if(n.cacheKeys&&n.cacheKeys.length)for(var u;u=n.cacheKeys.pop();)t.each(this.cache[u],s(n,u,this.cache));0===i.length&&(delete e[n.topic],t.isEmpty(e)&&delete this.subscriptions[n.channel])}this.configuration.enableSystemMessages&&this.publish(S(n))}},unsubscribeFor:function(t){var n=[];this.subscriptions&&(n=this.getSubscribersFor(t),this.unsubscribe.apply(this,n))}},u.subscriptions[u.configuration.SYSTEM_CHANNEL]={},n&&Object.prototype.hasOwnProperty.call(n,"__postalReady__")&&t.isArray(n.__postalReady__))for(;n.__postalReady__.length;)n.__postalReady__.shift().onReady(u);return u});