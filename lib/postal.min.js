/**
 * postal - Pub/Sub library providing wildcard subscriptions, complex message handling, etc.  Works server and client-side.
 * Author: Jim Cowart (http://freshbrewedcode.com/jimcowart)
 * Version: v0.11.1
 * Url: http://github.com/postaljs/postal.js
 * License(s): MIT
 */
(function(t,n){"function"==typeof define&&define.amd?define(["lodash"],function(e){return n(e,t)}):"object"==typeof module&&module.exports?module.exports=n({},this):t.postal=n(t._,t)})(this,function(t,n,e){function i(t,n){return function(){if(console.warn||console.log){var e="Warning, the "+t+" method has been deprecated. Please use "+n+" instead.";console.warn?console.warn(e):console.log(e)}return l.prototype[n].apply(this,arguments)}}function r(){for(;x.length;)u.unsubscribe(x.shift())}function o(t,n,e){return function(i,r,o){i===t&&o.splice(r,1),0===o.length&&delete e[n]}}function s(t,n,e,i,r){return function(o){t.resolver.compare(o.topic,n)&&(e.push(o),o.cacheKeys.push(i),r&&r(o))}}function c(t,n){return{channel:u.configuration.SYSTEM_CHANNEL,topic:"subscription."+t,data:{event:"subscription."+t,channel:n.channel,topic:n.topic}}}function a(t,n){return"function"==typeof t?t:t?function(e){var i,r,o=0,s=0;for(i in t)r=t[i],o+=1,("topic"===i&&n.compare(e.topic,t.topic)||"context"===i&&t.context===e._context||e[i]===t[i])&&(s+=1);return o===s}:function(){return!0}}var u,h=n.postal,f=function(t,n){this.bus=n,this.channel=t||u.configuration.DEFAULT_CHANNEL};f.prototype.subscribe=function(){return this.bus.subscribe({channel:this.channel,topic:1===arguments.length?arguments[0].topic:arguments[0],callback:1===arguments.length?arguments[0].callback:arguments[1]})},f.prototype.publish=function(){var t=1===arguments.length?"[object String]"===Object.prototype.toString.call(arguments[0])?{topic:arguments[0]}:arguments[0]:{topic:arguments[0],data:arguments[1]};t.channel=this.channel,this.bus.publish(t)};var l=function(t,n,i){if(3!==arguments.length)throw new Error("You must provide a channel, topic and callback when creating a SubscriptionDefinition instance.");if(0===n.length)throw new Error("Topics cannot be empty");this.channel=t,this.topic=n,this.callback=i,this.pipeline=[],this.cacheKeys=[],this._context=e},p=function(t){var n={};for(var e in t)n[e]=t[e]&&"object"==typeof t[e]?p(t[e]):t[e];return n},b=function(t,n){if(t===n)return!0;if(!(t instanceof Object&&n instanceof Object))return!1;if(t.constructor!==n.constructor)return!1;for(var e in t)if(t.hasOwnProperty(e)){if(!n.hasOwnProperty(e))return!1;if(t[e]!==n[e]){if("object"!=typeof t[e])return!1;if(!b(t[e],n[e]))return!1}}for(e in n)if(n.hasOwnProperty(e)&&!t.hasOwnProperty(e))return!1;return!0},g=function(){var t;return function(n){var e=!1;return"string"==typeof n?(e=n===t,t=n):(e=b(n,t),t=p(n)),!e}},d=function(){var t=[];return function(n){var e=!0;return t.every(function(t){var i=typeof n,r="function"===i||n&&"object"===i||!1;return(r||Array.isArray(n))&&b(n,t)?(e=!1,!1):n===t?(e=!1,!1):!0}),e&&t.push(n),e}},y=function(t,n,e){var i;return function(){var r=this,o=arguments,s=function(){i=null,e||t.apply(r,o)},c=e&&!i;clearTimeout(i),i=setTimeout(s,n),c&&t.apply(r,o)}},m=function(t,n,e){n=n||250;var i,r;return function(){var o=e||this,s=+new Date,c=arguments;i&&i+n>s?(clearTimeout(r),r=setTimeout(function(){i=s,t.apply(o,c)},n)):(i=s,t.apply(o,c))}};l.prototype={"catch":function(t){var n=this.callback,e=function(){try{n.apply(this,arguments)}catch(e){t(e,arguments[0])}};return this.callback=e,this},defer:function(){return this.delay(0)},disposeAfter:function(t){if("number"!=typeof t||0>=t)throw new Error("The value provided to disposeAfter (maxCalls) must be a number greater than zero.");var n=this,e=t,i=function(){return--e<1?n.unsubscribe():void 0};return n.pipeline.push(function(t,n,e){e(t,n),i()}),n},distinct:function(){return this.constraint(new d)},distinctUntilChanged:function(){return this.constraint(new g)},invokeSubscriber:function(t,n){if(!this.inactive){var e=this,i=e.pipeline,r=i.length,o=e._context,s=-1;if(r){i=i.concat([e.callback]);var c=function a(t,n){s+=1,r>s?i[s].call(o,t,n,a):e.callback.call(o,t,n)};c(t,n,0)}else e.callback.call(o,t,n)}},logError:function(){if(console){var t;t=console.warn?console.warn:console.log,this["catch"](t)}return this},once:function(){return this.disposeAfter(1)},subscribe:function(t){return this.callback=t,this},unsubscribe:function(){this.inactive||u.unsubscribe(this)},constraint:function(t){if("function"!=typeof t)throw new Error("Predicate constraint must be a function");return this.pipeline.push(function(n,e,i){t.call(this,n,e)&&i(n,e)}),this},constraints:function(t){var n=this;return Array.isArray(t)&&t.forEach(function(t){n.constraint(t)}),n},context:function(t){return this._context=t,this},debounce:function(t,n){if("number"!=typeof t)throw new Error("Milliseconds must be a number");return this.pipeline.push(y(function(t,n,e){e(t,n)},t,!!n)),this},delay:function(t){if("number"!=typeof t)throw new Error("Milliseconds must be a number");var n=this;return n.pipeline.push(function(n,e,i){setTimeout(function(){i(n,e)},t)}),this},throttle:function(t){if("number"!=typeof t)throw new Error("Milliseconds must be a number");var n=function(t,n,e){e(t,n)};return this.pipeline.push(m(n,t)),this}};for(var v=["withConstraint","withConstraints","withContext","withDebounce","withDelay","withThrottle"],w=["constraint","constraints","context","debounce","delay","throttle"],E=0;6>E;E++){var _=v[E];l.prototype[_]=i(_,w[E])}var T={cache:{},regex:{},compare:function(t,n){var e,i,r,o=this.cache[n+"-"+t];return o===!0?o:-1===t.indexOf("#")&&-1===t.indexOf("*")?o=this.cache[n+"-"+t]=n===t:((i=this.regex[t])||(e="^"+t.split(".").map(function(t){var n="";return r&&(n="#"!==r?"\\.\\b":"\\b"),n+="#"===t?"[\\s\\S]*":"*"===t?"[^.]+":t,r=t,n}).join("")+"$",i=this.regex[t]=new RegExp(e)),o=this.cache[n+"-"+t]=i.test(n))},reset:function(){this.cache={},this.regex={}}},A=0,x=[],S=c.bind(this,"created"),k=c.bind(this,"removed");if(u={cache:{},configuration:{resolver:T,DEFAULT_CHANNEL:"/",SYSTEM_CHANNEL:"postal",enableSystemMessages:!0,cacheKeyDelimiter:"|"},subscriptions:{},wireTaps:[],ChannelDefinition:f,SubscriptionDefinition:l,channel:function(t){return new f(t,this)},addWireTap:function(t){var n=this;return n.wireTaps.push(t),function(){var e=n.wireTaps.indexOf(t);-1!==e&&n.wireTaps.splice(e,1)}},noConflict:function(){if("undefined"==typeof window||"undefined"!=typeof window&&"function"==typeof define&&define.amd)throw new Error("noConflict can only be used in browser clients which aren't using AMD modules");return n.postal=h,this},getSubscribersFor:function(t){var n,e,i,r,o=[],s=this;for(n in s.subscriptions){e=s.subscriptions[n];for(i in e)r=e[i],o=o.concat(r.filter(a(t,s.configuration.resolver)))}return o},publish:function(t){++A;var n=this.configuration,e=t.channel=t.channel||n.DEFAULT_CHANNEL,i=t.topic;t.timeStamp=new Date,this.wireTaps.length&&this.wireTaps.forEach(function(n){n(t.data,t,A)});var o,c=e+n.cacheKeyDelimiter+i,a=this.cache[c];if(a){var u;for(o in a)u=a[o],u.invokeSubscriber(t.data,t)}else{a=this.cache[c]=[];var h,f=s(n,i,a,c,function(n){n.invokeSubscriber(t.data,t)});for(o in this.subscriptions[e])h=this.subscriptions[e][o],h.forEach(f)}0===--A&&r()},reset:function(){this.unsubscribeFor(),this.configuration.resolver.reset(),this.subscriptions={}},subscribe:function(t){var n,e=this.subscriptions,i=new l(t.channel||this.configuration.DEFAULT_CHANNEL,t.topic,t.callback),r=e[i.channel],o=i.channel.length,c=this.configuration;r||(r=e[i.channel]={}),n=e[i.channel][i.topic],n||(n=e[i.channel][i.topic]=[]),n.push(i);var a,u;for(u in this.cache)a=this.cache[u],u.substr(0,o)===i.channel&&s(c,u.split(c.cacheKeyDelimiter)[1],a,u)(i);return this.configuration.enableSystemMessages&&this.publish(S(i)),i},unsubscribe:function(){for(var t,n,e,i,r=arguments.length,s=0;r>s;s++){if(t=arguments[s],t.inactive=!0,A)return x.push(t),void 0;if(n=this.subscriptions[t.channel],e=n&&n[t.topic]){var c=e.length;for(i=0;c>i;){if(e[i]===t){e.splice(i,1);break}i+=1}if(t.cacheKeys&&t.cacheKeys.length)for(var a;a=t.cacheKeys.pop();)this.cache[a].forEach(o(t,a,this.cache));0===e.length&&(delete n[t.topic],Object.keys(n).length||delete this.subscriptions[t.channel])}this.configuration.enableSystemMessages&&this.publish(k(t))}},unsubscribeFor:function(t){var n=[];this.subscriptions&&(n=this.getSubscribersFor(t),this.unsubscribe.apply(this,n))}},u.subscriptions[u.configuration.SYSTEM_CHANNEL]={},n&&Object.prototype.hasOwnProperty.call(n,"__postalReady__")&&Array.isArray(n.__postalReady__))for(;n.__postalReady__.length;)n.__postalReady__.shift().onReady(u);return u});