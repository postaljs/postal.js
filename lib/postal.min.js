/**
 * postal - Pub/Sub library providing wildcard subscriptions, complex message handling, etc.  Works server and client-side.
 * Author: Jim Cowart (http://ifandelse.com)
 * Version: v0.12.4
 * Url: http://github.com/postaljs/postal.js
 * License(s): MIT
 */
(function(t,n){var e,e={after:function(t,n){return t=Number.isFinite(t=+t)?t:0,function(){return--t<1?n.apply(this,arguments):void 0}},any:function(t,n){for(var e=-1,i=t.length;++e<i;)if(n(t[e],e,t))return!0;return!1},bind:function(t,n,e){return t.bind(n,e)},clone:function(t){if(null===t||"object"!=typeof t)return t;var n=t.constructor();for(var i in t)t.hasOwnProperty(i)&&(n[i]=e.clone(t[i]));return n},debounce:function(t,n,e){var i;return function(){var r=this,c=arguments,o=function(){i=null,e||t.apply(r,c)},s=e&&!i;clearTimeout(i),i=setTimeout(o,n),s&&t.apply(r,c)}},each:function(t,n){if(Array.isArray(t))return t.forEach(n);for(var e in t)t.hasOwnProperty(e)&&n(t[e],e)},filter:function(t,n){return t.filter(n)},isArray:function(t){return Array.isArray(t)},isEmpty:function(t){return null===t?!0:!Object.keys(t).length},isEqual:function(t,n){if(t===n)return!0;if(!(t instanceof Object&&n instanceof Object))return!1;if(t.constructor!==n.constructor)return!1;for(var i in t)if(t.hasOwnProperty(i)){if(!n.hasOwnProperty(i))return!1;if(t[i]!==n[i]){if("object"!=typeof t[i])return!1;if(!e.isEqual(t[i],n[i]))return!1}}for(i in n)if(n.hasOwnProperty(i)&&!t.hasOwnProperty(i))return!1;return!0},isFunction:function(t){return"function"==typeof t||!1},isNumber:function(t){return"number"==typeof t&&Number.isFinite(t)},isObject:function(t){return null!==t&&"object"==typeof t},isString:function(t){return null!==t&&"string"==typeof t},map:function(t,n){return t.map(n)},throttle:function(t,n){var e,i;return function(){var r=+new Date,c=arguments;e&&e+n>r?(clearTimeout(i),i=setTimeout(function(){e=r,t.apply(this,c)},n)):(e=r,t.apply(this,c))}},extend:function(t,n){var e=Object.keys(n);e||(e=t,t={});for(var i=-1,r=e.length;++i<r;){var c=e[i];t[c]=n[c]}return t}};"function"==typeof define&&define.amd?define(function(){return n(e,t)}):"object"==typeof module&&module.exports?module.exports=n(e,this):t.postal=n(e,t)})(this,function(t,n,e){function i(t,n){return function(){if(console.warn||console.log){var e="Warning, the "+t+" method has been deprecated. Please use "+n+" instead.";console.warn?console.warn(e):console.log(e)}return b.prototype[n].apply(this,arguments)}}function r(){for(;_.length;)l.unsubscribe(_.shift())}function c(t,n,e){return function(i,r,c){i===t&&c.splice(r,1),0===c.length&&delete e[n]}}function o(t,n,e,i,r){var c=r&&r.headers||{};return function(r){f.resolver.compare(r.topic,t,c)&&(n.push(r),r.cacheKeys.push(e),i&&i(r))}}function s(t,n){return{channel:f.SYSTEM_CHANNEL,topic:"subscription."+t,data:{event:"subscription."+t,channel:n.channel,topic:n.topic}}}function a(n,e){return"function"==typeof n?n:n?function(i){var r=0,c=0;return t.each(n,function(t,o){r+=1,("topic"===o&&e.compare(i.topic,n.topic,{resolverNoCache:!0})||"context"===o&&n.context===i._context||i[o]===n[o])&&(c+=1)}),r===c}:function(){return!0}}var u=n.postal,h={minDash:t,DEFAULT_CHANNEL:"/",SYSTEM_CHANNEL:"postal",enableSystemMessages:!0,cacheKeyDelimiter:"|",autoCompactResolver:!1},l={configuration:t.extend({},h)},f=l.configuration,p=function(t,n){this.bus=n,this.channel=t||f.DEFAULT_CHANNEL};p.prototype.subscribe=function(){return this.bus.subscribe({channel:this.channel,topic:1===arguments.length?arguments[0].topic:arguments[0],callback:1===arguments.length?arguments[0].callback:arguments[1]})},p.prototype.publish=function(){var t,n={};"string"==typeof arguments[0]?(n.topic=arguments[0],n.data=arguments[1],t=arguments[2]):(n=arguments[0],t=arguments[1]),n.channel=this.channel,this.bus.publish(n,t)};var b=function(t,n,i){if(3!==arguments.length)throw new Error("You must provide a channel, topic and callback when creating a SubscriptionDefinition instance.");if(0===n.length)throw new Error("Topics cannot be empty");this.channel=t,this.topic=n,this.callback=i,this.pipeline=[],this.cacheKeys=[],this._context=e},d=function(){var n;return function(e){var i=!1;return t.isString(e)?(i=e===n,n=e):(i=t.isEqual(e,n),n=t.clone(e)),!i}},m=function(){var n=[];return function(e){var i=!t.any(n,function(n){return t.isObject(e)||t.isArray(e)?t.isEqual(e,n):e===n});return i&&n.push(e),i}};b.prototype={"catch":function(t){var n=this.callback,e=function(){try{n.apply(this,arguments)}catch(e){t(e,arguments[0])}};return this.callback=e,this},defer:function(){return this.delay(0)},disposeAfter:function(n){if(!t.isNumber(n)||0>=n)throw new Error("The value provided to disposeAfter (maxCalls) must be a number greater than zero.");var e=this,i=t.after(n,t.bind(function(){e.unsubscribe()}));return e.pipeline.push(function(t,n,e){e(t,n),i()}),e},distinct:function(){return this.constraint(new m)},distinctUntilChanged:function(){return this.constraint(new d)},invokeSubscriber:function(t,n){if(!this.inactive){var e=this,i=e.pipeline,r=i.length,c=e._context,o=-1,s=!1;if(r){i=i.concat([e.callback]);var a=function u(t,n){o+=1,r>o?i[o].call(c,t,n,u):(e.callback.call(c,t,n),s=!0)};a(t,n,0)}else e.callback.call(c,t,n),s=!0;return s}},logError:function(){if(console){var t;t=console.warn?console.warn:console.log,this["catch"](t)}return this},once:function(){return this.disposeAfter(1)},subscribe:function(t){return this.callback=t,this},unsubscribe:function(){this.inactive||l.unsubscribe(this)},constraint:function(n){if(!t.isFunction(n))throw new Error("Predicate constraint must be a function");return this.pipeline.push(function(t,e,i){n.call(this,t,e)&&i(t,e)}),this},constraints:function(n){var e=this;return t.isArray(n)&&t.each(n,function(t){e.constraint(t)}),e},context:function(t){return this._context=t,this},debounce:function(n,e){if(!t.isNumber(n))throw new Error("Milliseconds must be a number");return this.pipeline.push(t.debounce(function(t,n,e){e(t,n)},n,!!e)),this},delay:function(n){if(!t.isNumber(n))throw new Error("Milliseconds must be a number");var e=this;return e.pipeline.push(function(t,e,i){setTimeout(function(){i(t,e)},n)}),this},throttle:function(n){if(!t.isNumber(n))throw new Error("Milliseconds must be a number");var e=function(t,n,e){e(t,n)};return this.pipeline.push(t.throttle(e,n)),this}};for(var v=["withConstraint","withConstraints","withContext","withDebounce","withDelay","withThrottle"],y=["constraint","constraints","context","debounce","delay","throttle"],g=0;6>g;g++){var w=v[g];b.prototype[w]=i(w,y[g])}var E=(f.resolver={cache:{},regex:{},enableCache:!0,compare:function(n,e,i){var r,c,o,s=e+f.cacheKeyDelimiter+n,a=this.cache[s],u=i||{},h=this.enableCache&&!u.resolverNoCache;return a===!0?a:-1===n.indexOf("#")&&-1===n.indexOf("*")?(a=e===n,h&&(this.cache[s]=a),a):((c=this.regex[n])||(r="^"+t.map(n.split("."),function(t){var n="";return o&&(n="#"!==o?"\\.\\b":"\\b"),n+="#"===t?"[\\s\\S]*":"*"===t?"[^.]+":t,o=t,n}).join("")+"$",c=this.regex[n]=new RegExp(r)),a=c.test(e),h&&(this.cache[s]=a),a)},reset:function(){this.cache={},this.regex={}},purge:function(n){var e=this,i=f.cacheKeyDelimiter,r=function(t,r){var c=r.split(i),o=c[0],s=c[1];"undefined"!=typeof n.topic&&n.topic!==o||"undefined"!=typeof n.binding&&n.binding!==s||delete e.cache[r]},c=function(t,n){var r=n.split(i);0===l.getSubscribersFor({topic:r[0]}).length&&delete e.cache[n]};if("undefined"==typeof n)this.reset();else{var o=n.compact===!0?c:r;t.each(this.cache,o)}}},0),_=[],x=0,A=t.bind(s,this,"created"),C=t.bind(s,this,"removed");if(t.extend(l,{cache:{},subscriptions:{},wireTaps:[],ChannelDefinition:p,SubscriptionDefinition:b,channel:function(t){return new p(t,this)},addWireTap:function(t){var n=this;return n.wireTaps.push(t),function(){var e=n.wireTaps.indexOf(t);-1!==e&&n.wireTaps.splice(e,1)}},noConflict:function(){if("undefined"==typeof window||"undefined"!=typeof window&&"function"==typeof define&&define.amd)throw new Error("noConflict can only be used in browser clients which aren't using AMD modules");return n.postal=u,this},getSubscribersFor:function(n){var e=[],i=this;return t.each(i.subscriptions,function(i){t.each(i,function(i){e=e.concat(t.filter(i,a(n,f.resolver)))})}),e},publish:function(n,e){++E;var i=n.channel=n.channel||f.DEFAULT_CHANNEL,c=n.topic;n.timeStamp=new Date,this.wireTaps.length&&t.each(this.wireTaps,function(t){t(n.data,n,E)});var s=i+f.cacheKeyDelimiter+c,a=this.cache[s],u=0,h=0;if(a)t.each(a,function(t){t.invokeSubscriber(n.data,n)?h++:u++});else{a=this.cache[s]=[];var l=o(c,a,s,function(t){t.invokeSubscriber(n.data,n)?h++:u++},n);t.each(this.subscriptions[i],function(n){t.each(n,l)})}0===--E&&r(),e&&e({activated:h,skipped:u})},reset:function(){this.unsubscribeFor(),f.resolver.reset(),this.subscriptions={}},subscribe:function(n){var e,i=this.subscriptions,r=new b(n.channel||f.DEFAULT_CHANNEL,n.topic,n.callback),c=i[r.channel],s=r.channel.length;return c||(c=i[r.channel]={}),e=i[r.channel][r.topic],e||(e=i[r.channel][r.topic]=[]),e.push(r),t.each(this.cache,function(t,n){n.substr(0,s)===r.channel&&o(n.split(f.cacheKeyDelimiter)[1],t,n)(r)}),f.enableSystemMessages&&this.publish(A(r)),r},unsubscribe:function(){for(var n,e,i,r,o=arguments.length,s=0;o>s;s++){if(n=arguments[s],n.inactive=!0,E)return _.push(n),void 0;if(e=this.subscriptions[n.channel],i=e&&e[n.topic]){var a=i.length;for(r=0;a>r;){if(i[r]===n){i.splice(r,1);break}r+=1}if(0===i.length&&(delete e[n.topic],t.isEmpty(e)&&delete this.subscriptions[n.channel]),n.cacheKeys&&n.cacheKeys.length)for(var u;u=n.cacheKeys.pop();)t.each(this.cache[u],c(n,u,this.cache));if("function"==typeof f.resolver.purge){var h=f.autoCompactResolver===!0?0:"number"==typeof f.autoCompactResolver?f.autoCompactResolver-1:!1;h>=0&&x===h?(f.resolver.purge({compact:!0}),x=0):h>=0&&h>x&&(x+=1)}}f.enableSystemMessages&&this.publish(C(n))}},unsubscribeFor:function(t){var n=[];this.subscriptions&&(n=this.getSubscribersFor(t),this.unsubscribe.apply(this,n))}}),n&&Object.prototype.hasOwnProperty.call(n,"__postalReady__")&&t.isArray(n.__postalReady__))for(;n.__postalReady__.length;)n.__postalReady__.shift().onReady(l);return l});