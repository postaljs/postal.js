(function(a,b,c){var d="/",e=50,f=0,g="postal",h=function(){},i=function(){var b;return function(c){var d=!1;return a.isString(c)?(d=c===b,b=c):(d=a.isEqual(c,b),b=a.clone(c)),!d}},j=function(){var b=[];return function(c){var d=!a.any(b,function(b){return a.isObject(c)||a.isArray(c)?a.isEqual(c,b):c===b});return d&&b.push(c),d}},k=function(a,b){this.channel=a||d,this._topic=b||""};k.prototype={subscribe:function(){var a=arguments.length;if(a===1)return new l(this.channel,this._topic,arguments[0]);if(a===2)return new l(this.channel,arguments[0],arguments[1])},publish:function(a){var b=a||{},c={channel:this.channel,topic:this._topic,data:b};return b.topic&&b.data&&(c=b,c.channel=c.channel||this.channel),c.timeStamp=new Date,r.configuration.bus.publish(c),c},topic:function(a){return a===this._topic?this:new k(this.channel,a)}};var l=function(a,b,c){this.channel=a,this.topic=b,this.callback=c,this.priority=e,this.constraints=new Array(0),this.maxCalls=f,this.onHandled=h,this.context=null,r.configuration.bus.publish({channel:g,topic:"subscription.created",timeStamp:new Date,data:{event:"subscription.created",channel:a,topic:b}}),r.configuration.bus.subscribe(this)};l.prototype={unsubscribe:function(){r.configuration.bus.unsubscribe(this),r.configuration.bus.publish({channel:g,topic:"subscription.removed",timeStamp:new Date,data:{event:"subscription.removed",channel:this.channel,topic:this.topic}})},defer:function(){var a=this.callback;return this.callback=function(b){setTimeout(a,0,b)},this},disposeAfter:function(b){if(a.isNaN(b)||b<=0)throw"The value provided to disposeAfter (maxCalls) must be a number greater than zero.";var c=this.onHandled,d=a.after(b,a.bind(function(){this.unsubscribe(this)},this));return this.onHandled=function(){c.apply(this.context,arguments),d()},this},ignoreDuplicates:function(){return this.withConstraint(new i),this},distinct:function(){return this.withConstraint(new j),this},withConstraint:function(b){if(!a.isFunction(b))throw"Predicate constraint must be a function";return this.constraints.push(b),this},withConstraints:function(b){var c=this;return a.isArray(b)&&a.each(b,function(a){c.withConstraint(a)}),c},withContext:function(a){return this.context=a,this},withDebounce:function(b){if(a.isNaN(b))throw"Milliseconds must be a number";var c=this.callback;return this.callback=a.debounce(c,b),this},withDelay:function(b){if(a.isNaN(b))throw"Milliseconds must be a number";var c=this.callback;return this.callback=function(a){setTimeout(function(){c(a)},b)},this},withPriority:function(b){if(a.isNaN(b))throw"Priority must be a number";return this.priority=b,r.configuration.bus.changePriority(this),this},withThrottle:function(b){if(a.isNaN(b))throw"Milliseconds must be a number";var c=this.callback;return this.callback=a.throttle(c,b),this},subscribe:function(a){return this.callback=a,this}};var m={cache:{},compare:function(a,b){if(this.cache[b]&&this.cache[b][a])return!0;var c=new RegExp("^"+a.replace(/\./g,"\\.").replace(/\*/g,".*").replace(/#/g,"[A-Z,a-z,0-9]*")+"$"),d=c.test(b);return d&&(this.cache[b]||(this.cache[b]={}),this.cache[b][a]=!0),d},reset:function(){this.cache={}}},n={addWireTap:function(a){var b=this;return b.wireTaps.push(a),function(){var c=b.wireTaps.indexOf(a);c!==-1&&b.wireTaps.splice(c,1)}},changePriority:function(b){var c,d;if(this.subscriptions[b.channel]&&this.subscriptions[b.channel][b.topic]){this.subscriptions[b.channel][b.topic]=a.without(this.subscriptions[b.channel][b.topic],b),c=this.subscriptions[b.channel][b.topic].length-1;for(;c>=0;c--)if(this.subscriptions[b.channel][b.topic][c].priority<=b.priority){this.subscriptions[b.channel][b.topic].splice(c+1,0,b),d=!0;break}d||this.subscriptions[b.channel][b.topic].unshift(b)}},publish:function(b){a.each(this.wireTaps,function(a){a(b.data,b)}),a.each(this.subscriptions[b.channel],function(c){a.each(c,function(c){r.configuration.resolver.compare(c.topic,b.topic)&&a.all(c.constraints,function(a){return a(b.data,b)})&&typeof c.callback=="function"&&(c.callback.apply(c.context,[b.data,b]),c.onHandled())})})},reset:function(){this.subscriptions&&(a.each(this.subscriptions,function(b){a.each(b,function(a){while(a.length)a.pop().unsubscribe()})}),this.subscriptions={})},subscribe:function(a){var b,c,d,e=this.subscriptions[a.channel],f;return e||(e=this.subscriptions[a.channel]={}),f=this.subscriptions[a.channel][a.topic],f||(f=this.subscriptions[a.channel][a.topic]=new Array(0)),f.push(a),a},subscriptions:{},wireTaps:new Array(0),unsubscribe:function(a){if(this.subscriptions[a.channel][a.topic]){var b=this.subscriptions[a.channel][a.topic].length,c=0;for(;c<b;c++)if(this.subscriptions[a.channel][a.topic][c]===a){this.subscriptions[a.channel][a.topic].splice(c,1);break}}}},o={1:function(a){if(!a)throw new Error("publishing from the 'global' postal.publish call requires a valid envelope.");return a.channel=a.channel||d,a.timeStamp=new Date,r.configuration.bus.publish(a),a},2:function(a,b){var c={channel:d,topic:a,timeStamp:new Date,data:b};return r.configuration.bus.publish(c),c},3:function(a,b,c){var d={channel:a,topic:b,timeStamp:new Date,data:c};return r.configuration.bus.publish(d),d}},p={1:function(a){var b=a,c,e={};return Object.prototype.toString.call(b)==="[object String]"?(b=d,c=a):(b=a.channel||d,c=a.topic,e=a.options||e),new r.channelTypes[e.type||"local"](b,c)},2:function(a,b){var c=a,e=b,f={};return Object.prototype.toString.call(b)==="[object Object]"&&(c=d,e=a,f=b),new r.channelTypes[f.type||"local"](c,e)},3:function(a,b,c){return new r.channelTypes[c.type||"local"](a,b)}},q={};n.subscriptions[g]={};var r={configuration:{bus:n,resolver:m,DEFAULT_CHANNEL:d,DEFAULT_PRIORITY:e,DEFAULT_DISPOSEAFTER:f,SYSTEM_CHANNEL:g},channelTypes:{local:k},channel:function(){var a=arguments.length;if(p[a])return p[a].apply(this,arguments)},subscribe:function(a){var b=a.callback,c=a.topic,e=a.channel||d;return new l(e,c,b)},publish:function(){var a=arguments.length;if(o[a])return o[a].apply(this,arguments)},addWireTap:function(a){return this.configuration.bus.addWireTap(a)},linkChannels:function(b,c){var e=[];return a.isArray(b)||(b=[b]),a.isArray(c)||(c=[c]),a.each(b,function(b){var f=b.topic||"*";a.each(c,function(c){var f=c.channel||d;e.push(r.subscribe({channel:b.channel||d,topic:b.topic||"*",callback:function(b,d){var e=d;e.topic=a.isFunction(c.topic)?c.topic(d.topic):c.topic||d.topic,e.channel=f,e.data=b,r.publish(e)}}))})}),e},utils:{getSubscribersFor:function(){var a=arguments[0],b=arguments[1],c=[];return arguments.length===1&&(Object.prototype.toString.call(a)==="[object String]"?(a=r.configuration.DEFAULT_CHANNEL,b=arguments[0]):(a=arguments[0].channel||r.configuration.DEFAULT_CHANNEL,b=arguments[0].topic)),r.configuration.bus.subscriptions[a]&&r.configuration.bus.subscriptions[a].hasOwnProperty(b)&&(c=r.configuration.bus.subscriptions[a][b]),c},reset:function(){r.configuration.bus.reset(),r.configuration.resolver.reset()}}};b.postal=r})(_,window)